{% extends "base.html" %}
{% block title %}{{ album.name }}{% endblock %}
{% block head_extra %}
<script src="{{ url_for('static', filename='js/album.js') }}"></script>
{% endblock %}

{% block content %}
<h2 class="page-title">{{ album.name }}</h2>

{% if remaining_seconds > 0 %}
<div class="spin-timer">
  Next spin available in
  <span id="spin-countdown" data-remaining="{{ remaining_seconds }}"></span>
</div>
{% else %}
<div class="spin-timer spin-ready">
  You can spin the wheel now.
</div>
{% endif %}

<button id="toggle-cover-form" class="cover-button">Change Cover</button>

<div id="cover-form-wrapper" class="change-cover-form" style="display:none;">
  <form action="{{ url_for('upload.change_cover', album_id=album.id) }}" method="post" enctype="multipart/form-data">
    <label>
      Select new cover (4:3 only):
      <input type="file" name="cover" accept="image/*">
    </label>
    <button type="submit">Update Cover</button>
  </form>
</div>


<div class="video-grid" data-album-id="{{ album.id }}">
  {% for video in album.videos %}
  <div class="video-card" data-video-id="{{ video.id }}">
    <div class="video-thumb-wrapper">
      <img src="{{ url_for('media.serve_thumbnail', album_id=album.id, video_id=video.id) }}" alt="{{ video.title }}"
        class="video-thumb js-video-thumb"
        data-video-url="{{ url_for('albums.play_video', album_id=album.id, video_id=video.id, version='main') }}">
    </div>

    <form action="{{ url_for('spin.spin', album_id=album.id, video_id=video.id) }}" method="get">
      <button type="submit" class="spin-button">Spin for uncensored version</button>
    </form>
  </div>
  {% else %}
  <p>No videos in this album yet.</p>
  {% endfor %}
</div>

<script>
  (function () {
    const el = document.getElementById('spin-countdown');
    if (!el) return;

    let remaining = parseInt(el.dataset.remaining, 10);

    function format(sec) {
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    function tick() {
      if (remaining <= 0) {
        el.textContent = "00:00:00";
        return;
      }
      el.textContent = format(remaining);
      remaining -= 1;
      setTimeout(tick, 1000);
    }

    tick();
  })();
</script>

<script>
  document.getElementById("toggle-cover-form").onclick = () => {
    const wrapper = document.getElementById("cover-form-wrapper");
    wrapper.style.display = wrapper.style.display === "none" ? "block" : "none";
  };
</script>


{% endblock %}